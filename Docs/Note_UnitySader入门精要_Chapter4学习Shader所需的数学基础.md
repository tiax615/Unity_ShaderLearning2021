# 4. 学习Shader所需的数学基础
最常用的是矢量和矩阵（线代）（为什么不好好学数学）。

## 4.1 背景：农场游戏
假定在开发农场游戏，主角是壮牛妞妞。

## 4.2 笛卡儿坐标系
Cartesian Coordinate System。

### 4.2.1 二维笛卡儿坐标系
略

### 4.2.2 三维笛卡儿坐标系
在三维笛卡儿坐标系重，我们要定义3个坐标轴和一个原点。

![](./image/4.1.png)

这3个坐标轴也叫**基矢量（basis vector）**。如果3个坐标轴互相垂直且长度为1，称为**标准正交基**。如果它们互相垂直但长度不为1，称为**正交基**。默认情况使用的坐标轴指标准正交基。

因坐标轴方向不同，分为左手坐标系（left-handed coordinate space）和右手坐标系（right-handed coordinate space）

### 4.2.3 左手坐标系和右手坐标系
二维坐标系，总可以通过一些旋转操作使它们的坐标轴指向相同。三维有时候不行。

判断左手还是右手坐标系的方法略。两种坐标系的旋向性（handedness）不同。

判断绕坐标系旋转的正方向，作者描述的是在左手坐标系使用左手法则：举起左手握拳，大拇指指向旋转轴正方向，那么旋转的正方向就是剩下4个手指弯曲的方向。这个存疑，在UE4使用的左手坐标系中，X/Y轴右手法则是正方向，Z轴是左手法则。

### 4.2.4 Unity使用的坐标系
Unity使用的是左手坐标系，右X上Y前Z。

![](./image/4.2.png)

观察空间，是右手坐标系。观察空间指以相机为原点，相机前向是z轴负方向的坐标系。在这个坐标系里，z坐标减少意味着场景深度的增加，和模型空间定义相反。

![](./image/4.3.png)


### 4.2.5 练习题
解答如下：

1：右手坐标系

2：
* 在左手坐标系中，绕y轴正方向旋转90°，落在了x轴正方向上，坐标是(1,0,0)
* 在右手坐标系中，绕y轴正方向旋转90°，依然是落在了x轴正方向，坐标是(1,0,0)
* 虽然坐标相同，位置不同。如果y轴z轴相同时，两个坐标系x轴正方向刚好相反，所以变换后的点刚好yz平面对称

![](./image/4.4.jpg)

3：在相机的观察空间下，小球在相机前面10的位置，因为观察空间前是z的负方向，所以球体的z值是-10。在相机的模型空间中，z值是10，和观察空间刚好相反。

## 4.3 点和矢量
* 点 point
* 矢量/向量 vector
  * 模 magnitude
  * 方向 direction
* 标量 scalar

### 4.3.1 点和矢量的区别
点是一个没有大小之分的空间中的位置，矢量是一个有模和方向但没有位置的量。矢量通常用于描述偏移量，任何一个点都可以表示成一个从原点出发的矢量。

### 4.3.2 矢量运算
**1. 矢量和标量乘法/除法**

kv=(kvx,kvy,kvz)

**2. 矢量的加法和减法**

a±b=(ax±bx,ay±by,az±bz)

几何意义：
* 加法：把矢量a的头连接到矢量b的尾的矢量
* 减法：其实就是矢量a加矢量-b

![](./image/4.5.png)

**3. 矢量的模**

|v|=sqrt(vx²+vy²+vz²)

**4. 单位矢量**

单位矢量（unit vector）：模为1的矢量，很多情况下只关心方向而不是模。也被称为被归一化的矢量（normalized vector），转换成单位矢量的过程称为归一化（normalization）。

v单=v/|v|

零矢量不可以被归一化。

**5. 矢量的点积**

点积（dot product，也叫内积，inner product）。

* a·b=(ax,ay,az)·(bx,by,bz)=axbx+ayby+azbz
* a·b=b·a

几何意义：a·b表示矢量b在单位矢量a上的投影。a·b=|a||b|cosθ。

![](./image/4.6.png)

如果矢量a不是单位矢量，那么a·b表示b在a方向上的投影值，再乘以a的长度。

点积具有一些很重要的性质，有助于Shader的计算：
1. 点积可结合标量乘法。意义是对点积其中一个矢量进行缩放，相当于对最后的点积结果进行缩放：（ka)·b=a·(kb)=k(a·b)
2. 点积可结合矢量加法和减法。点积的操作数可以是矢量相加减后的结果：a·(b±c)=a·b±a·c
3. 一个矢量和本身进行点积的结果，是该矢量的模的平方：v·v=vxvx+vyvy+vzvz=|v|²

**6. 矢量的叉积**

叉积（cross produce，也叫外积，outer produce）。叉积的结果仍然是一个矢量。

axb=(ax,ay,az)x(bx,by,bz)=(aybz-azby,azbx-axbz,axby-aybx)

* 叉积不满足交换律：axb≠bxa
* 叉积满足反交换律：axb=-bxa（模相同方向刚好相反的两个向量）
* 叉积不满足结合律：(axb)xc≠ax(bxc)

几何意义：axb的结果是一个同时垂直于这两个矢量的新矢量。

叉积的模：|axb|=|a||b|sinθ。结果是a和b构成的平行四边形的面积。

![](./image/4.7.png)

叉积的方向：在左手坐标系中，使用左手法则。手心放在a和b的交点处，让手掌方向和a的方向重合，弯曲四指向b的方向靠拢，最后伸出大拇指，大拇指指向的方向就是左手坐标系中的axb的方向。在右手坐标系中使用右手法则，方向应该恰好和左手坐标系相反。

![](./image/4.8.png)

叉积的应用：最常见的一个应用就是计算垂直于一个平面、三角形的矢量。还可以判断三角面片的朝向。

### 4.3.3 练习题
解答如下：

1：
1. 否。矢量的位置不重要，它可以没有固定的位置，但矢量有大小（模）和方向
2. 是
3. 否。选择左手还是右手坐标系是很重要，但这并不影响叉积的计算

2：
1. sqrt(62)。|(2,7,3)|=sqrt(2²+7²+3²)=sqrt(4+49+9)=sqrt(62)
2. (12.5,10,25)。2.5(5,4,10)=(2.5x5,2.5x4,2.5x10)=(12.5,10,25)
3. (1.5,2)。(3,4)/2=0.5(3,4)=(1.5,2)
4. (5/13,12/13)。a=(5,12)，|a|=13，归一化a=a/|a|=(5/12,12/13)
5. (1,1,1)/sqrt(3)
6. (10,9)
7. (-6,1,2)

3：sqrt(308)。两点的距离矢量为(10,13,11)-(2,1,1)=(8,12,10)，距离为这个矢量的模sqrt(64+144+100)=sqrt(308)

4：
1. 75。(4,7)·(3,9)=4x3+7x9=12+63=75
2. 13。(2,5,6)·(3,1,2)-10=2x3+5x1+6x2-10=6+5+12-10=13
3. 13。0.5(-3,4)·(-2,5)=0.5(6+20)=13
4. (-9,-13,7)。(3,-1,2)x(-5,4,1)=(-1-8,-10-3,12-5)=(-9,-13,7)
5. (9,13,-7)。(-5,4,1)x(3,-1,2)=(8+1,3+10,5-12)=(9,13,-7)。和上面结果方向相反

5：
1. 12。a·b=|a||b|cosθ=4x6xcos(60)=12
2. |axb|=|a||b|sinθ=4x6xsin(60)=20.784

6：
1. a=x-p，θ=acos(v·a/(|v||a|))，θ<90即在前方，否则在后方。看v·a的符号也行，大于0即在前方，否则后方
2. 后方。a=(10-4,6-2)=(6,4),v·a=-3x6+4x4=-2<0，后方
3. 还是计算出角度a=x-p，θ=acos(v·a/(|v||a|))，θ<φ/2就能看到，否则不行。
4. 距离=|x-p|，即连接两点的向量的模，距离小于限制就可以观察到

7：v=(p2-p1)x(p3-p2)，因为p1p2p3都在xy平面上，所以叉积向量v一定垂直于xy平面，即(0,0,a)的形式。如果v的z分量a<0，则3个点是顺时针，否则逆时针。

## 4.4 矩阵
Matrix

### 4.4.1 矩阵的定义
由mxn个标量组成的长方形数组。

行（row）列（column），3x4的矩阵有3行4列。3x3的矩阵可以写成：

![](./image/4.9.png)

### 4.4.2 和矢量联系起来
矢量可以看成是nx1的列矩阵（column matirx），或1xn的行矩阵（row matirx）。如[3 8 6]。

### 4.4.3 矩阵运算
**1. 矩阵和标量的乘法**

就是每个元素和该标量相乘。

![](./image/4.10.png)

**2. 矩阵和矩阵的乘法**
一个rxn的矩阵A和一个nxc的矩阵B相乘，结果C=AB是一个rxc大小的矩阵。相乘的矩阵，第一个矩阵的列数必须和第二个矩阵的行数相同。

C中的每个元素Cij等于A的第i行所对应的矢量和B的第j列所对应的矢量进行点乘的结果，即：

![](./image/4.11.png)

先找到对应的行矩阵和列矩阵，把它们进行矢量点积后就可以得到结果值：

![](./image/4.12.png)

在Shader计算中，我们更多的是用4x4矩阵来运算的。矩阵乘法满足一些性质：
1. 矩阵乘法不满足交换律：AB≠BA
2. 矩阵乘法满足结合律：(AB)C=A(BC)

### 4.4.4 特殊的矩阵
**1. 方块矩阵**

square matrix，简称方阵，指行和列数目相等的矩阵。**对角元素（diagonal elements）**，指行号和列号相等的元素，例如m11、m22、m33。如果一个矩阵除了对角元素外的所有元素都为0，那么这个矩阵叫做**对角矩阵（diagonal matrix）**。如：

![](./image/4.13.png)

**2. 单位矩阵**

identity matrix，用In来表示，对角元素都是1的对角矩阵，一个3x3的单位矩阵如下：

![](./image/4.14.png)

任何矩阵和单位矩阵相乘的结果都是原来的矩阵：MI=IM=M

**3. 转置矩阵**

transposed matrix，对原矩阵进行转置运算。给定一个rxc的矩阵M，它的转置可以表示成MT，这是一个cxr的矩阵。把行列翻转一下，第i行变成了第i列，第j列变成了第j行：

![](./image/4.15.png)

转置矩阵的常用性质：
1. 矩阵转置的转置等于原矩阵：(MT)T=M
2. 矩阵串接的转置，等于反向串接各个矩阵的转置：(AB)T=BTAT

**4. 逆矩阵**

inverse matrix，方阵才可能有逆矩阵。用M-1表示，如果把M和M-1相乘，那么它们的结果会是一个单位矩阵：MM-1=M-1M=I

![](./image/4.16.png)

所有元素都是0的矩阵没有逆矩阵。如果一个矩阵有对应的逆矩阵，就是**可逆的（invertible）**或说是**非奇异的（nonsingular）**。反之，就是**不可逆的（noninvertible）**或说是**奇异的（singular）**。

如果一个矩阵的**行列式（determinant）**不为0，就是可逆的。

逆矩阵的重要性质：
1. 逆矩阵的逆矩阵是原矩阵本身：(M-1)-1=M
2. 单位矩阵的逆矩阵是它本身：I-1=I
3. 转置矩阵的逆矩阵是逆矩阵的转置：(MT)-1=(M-1)T
4. 矩阵串接相乘后的逆矩阵等于反向串接各个矩阵的逆矩阵：(AB)-1=B-1A-1

几何意义：可以使用逆矩阵还原变换。例如用变换矩阵M对矢量v进行了一次变换，再使用它的逆矩阵M-1进行一次变换就可以得到原来的矢量：M-1(Mv)=(M-1M)v=Iv=v

**5. 正交矩阵**

orthogonal matrix。如果一个方阵M和它的转置矩阵的乘积是单位矩阵的话，这个矩阵是正交的：MMT=MTM=I。

如果一个矩阵是正交的，那么它的转置矩阵和逆矩阵是一样的：MT=M-1。在三维变换中，经常用逆矩阵求反向的变换，但计算量很大，如果用转置矩阵代替，就容易求解。

![](./image/4.17.png)

以上演算可以得到结论：
1. c1、c2、c3的单位矢量，和自己的点积是1
2. c1、c2、c3之间互相垂直，之间的点积是0

如果一个矩阵满足上面的条件，那么它就是一个正交矩阵。一组标准正交基可以精确的满足上述条件（3个坐标轴互相垂直且长度为1）。这表示，使用标准正交基来构建坐标系的话，可以直接使用转置矩阵来求变换的逆变换。

### 4.4.5 行矩阵还是列矩阵
把矢量转换成行矩阵或列矩阵，会影响和矩阵相乘的结果。

在Unity中，常规做法是把矢量放在矩阵的右侧（作为列矩阵），矩阵乘法通常是右乘：CBAv=(C(B(Av)))，等价于vATBTCT=(((vAT)BT)CT)

### 4.4.6 练习题
1：
1. 存在
2. 不存在
3. 存在

![](./image/4.18.jpg)


2：通过正交矩阵的特性来判断。每个行向量应该是单位向量，并且互相垂直。
1. 否。三个行向量不互相垂直
2. 是。满足上述特性
3. 是。满足上述特性

3：1x3行矩阵乘3x3矩阵得到的是1x3行矩阵，3x3矩阵乘3x1列矩阵得到的是3x1列矩阵：
1. 相同。乘单位矩阵还是自己
2. 不同。Av=vAT
3. 相同。这个矩阵的转置还是自己（对称矩阵）